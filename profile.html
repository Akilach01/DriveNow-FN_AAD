<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - DriveNow</title>
    <link href="css/normalize_css.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="css/custom.css" rel="stylesheet">
</head>
<body>
<!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
    <div class="container">
        <a class="navbar-brand fw-bold" href="/">
            <i class="fas fa-car me-2"></i>DriveNow
        </a>
        <div class="navbar-nav ms-auto" id="authNav">
            <!-- Dynamic auth links -->
        </div>
    </div>
</nav>

<div class="container my-5">
    <div class="row">
        <div class="col-12">
            <div id="alert-container"></div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/">Home</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Profile</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row">
        <!-- Profile Sidebar -->
        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm">
                <div class="card-body text-center p-4">
                    <div class="avatar-placeholder mb-3 mx-auto" style="width: 100px; height: 100px; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-user fa-3x text-white"></i>
                    </div>
                    <h5 id="profileName" class="mb-1">Loading...</h5>
                    <p id="profileEmail" class="text-muted mb-2 small">Loading...</p>
                    <div class="d-flex justify-content-center gap-2 mb-3">
                        <span id="profileStatus" class="badge bg-success">Active</span>
                        <span id="profileRole" class="badge bg-primary">User</span>
                    </div>
                    <div class="small text-muted">
                        <div class="mb-1"><i class="fas fa-id-card me-2"></i>ID: <span id="profileId">Loading...</span></div>
                        <div><i class="fas fa-phone me-2"></i><span id="profileContact">Loading...</span></div>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm mt-4">
                <div class="card-body p-3">
                    <h6 class="card-title mb-3"><i class="fas fa-chart-line me-2 text-primary"></i>Quick Stats</h6>
                    <div class="row text-center">
                        <div class="col-6 border-end">
                            <div class="h6 mb-0 text-primary" id="totalBookings">0</div>
                            <small class="text-muted">Total Bookings</small>
                        </div>
                        <div class="col-6">
                            <div class="h6 mb-0 text-success" id="activeBookings">0</div>
                            <small class="text-muted">Active</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Content -->
        <div class="col-lg-8">
            <!-- Profile Header -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light border-0">
                    <h4 class="mb-0"><i class="fas fa-user-edit me-2 text-primary"></i>Profile Information</h4>
                </div>
                <div class="card-body">
                    <ul class="nav nav-tabs" id="profileTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="personal-tab" data-bs-toggle="tab"
                                    data-bs-target="#personal" type="button" role="tab">Personal Info</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="security-tab" data-bs-toggle="tab"
                                    data-bs-target="#security" type="button" role="tab">Security</button>
                        </li>
                    </ul>

                    <div class="tab-content mt-3" id="profileTabContent">
                        <!-- Personal Information Tab -->
                        <div class="tab-pane fade show active" id="personal" role="tabpanel">
                            <form id="profileForm" novalidate>
                                <input type="hidden" id="userId" name="userId">

                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="firstName" class="form-label">First Name *</label>
                                        <input type="text" class="form-control" id="firstName" name="firstName" required>
                                        <div class="invalid-feedback">First name is required</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="lastName" class="form-label">Last Name *</label>
                                        <input type="text" class="form-control" id="lastName" name="lastName" required>
                                        <div class="invalid-feedback">Last name is required</div>
                                    </div>

                                    <div class="col-md-6">
                                        <label for="email" class="form-label">Email *</label>
                                        <input type="email" class="form-control" id="email" name="email" required>
                                        <div class="invalid-feedback">Please enter a valid email</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="contact" class="form-label">Contact Number *</label>
                                        <input type="tel" class="form-control" id="contact" name="contact"
                                               pattern="\\+?\\d{10,15}" required>
                                        <div class="form-text">Format: +94712345678</div>
                                        <div class="invalid-feedback">Please enter a valid phone number</div>
                                    </div>

                                    <div class="col-md-6">
                                        <label for="nicNo" class="form-label">NIC Number *</label>
                                        <input type="text" class="form-control" id="nicNo" name="nicNo"
                                               pattern="\\d{9}V|\\d{12}" required readonly>
                                        <div class="form-text">Format: 123456789V or 123456789012</div>
                                        <div class="invalid-feedback">Please enter a valid NIC number</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="userName" class="form-label">Username *</label>
                                        <input type="text" class="form-control" id="userName" name="userName" required readonly>
                                        <div class="invalid-feedback">Username is required</div>
                                    </div>

                                    <div class="col-12">
                                        <label for="address" class="form-label">Address *</label>
                                        <textarea class="form-control" id="address" name="address" rows="3" required></textarea>
                                        <div class="invalid-feedback">Address is required</div>
                                    </div>

                                    <div class="col-12">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label">Account Status</label>
                                                <input type="text" class="form-control" id="status" name="status" readonly>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-12 mt-3">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save me-2"></i>Update Profile
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary ms-2"
                                                onclick="resetForm()">
                                            <i class="fas fa-undo me-2"></i>Reset
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>

                        <!-- Security Tab -->
                        <div class="tab-pane fade" id="security" role="tabpanel">
                            <form id="securityForm" novalidate>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="currentPassword" class="form-label">Current Password</label>
                                        <input type="password" class="form-control" id="currentPassword"
                                               name="currentPassword" required minlength="6">
                                        <div class="invalid-feedback">Current password is required</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="newPassword" class="form-label">New Password</label>
                                        <div class="input-group">
                                            <input type="password" class="form-control" id="newPassword"
                                                   name="newPassword" minlength="6">
                                            <button class="btn btn-outline-secondary" type="button"
                                                    id="toggleNewPassword">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                        <div class="form-text">Leave blank to keep current password</div>
                                    </div>

                                    <div class="col-md-6">
                                        <label for="confirmNewPassword" class="form-label">Confirm New Password</label>
                                        <input type="password" class="form-control" id="confirmNewPassword"
                                               name="confirmNewPassword" minlength="6">
                                        <div class="invalid-feedback">Passwords do not match</div>
                                    </div>

                                    <div class="col-12">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="passwordChange">
                                            <label class="form-check-label" for="passwordChange">
                                                I want to change my password
                                            </label>
                                        </div>
                                        <div class="form-text">
                                            Changing your password will log you out of all sessions
                                        </div>
                                    </div>

                                    <div class="col-12 mt-3">
                                        <button type="submit" class="btn btn-success">
                                            <i class="fas fa-key me-2"></i>Update Password
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary ms-2"
                                                onclick="resetSecurityForm()">
                                            <i class="fas fa-times me-2"></i>Cancel
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="js/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="js/app.js"></script>
<script>
    $(document).ready(function() {
        checkAuthStatus();
        if (!isAuthenticated()) {
            window.location.href = '/login.html';
            return;
        }

        loadProfileData();
        setupProfileHandlers();
    });

    function loadProfileData() {
        // Get current user ID from stored data
        const userData = JSON.parse(localStorage.getItem('currentUser') || '{}');
        const userId = userData.userId || getUserIdFromToken();

        if (!userId) {
            showAlert('Unable to load profile data', 'danger');
            return;
        }

        $.ajax({
            url: `/api/users/${userId}`,
            method: 'GET',
            headers: getAuthHeaders(),
            success: function(user) {
                populateProfileForm(user);
                populateProfileSidebar(user);
                loadBookingStats();
            },
            error: function() {
                showAlert('Failed to load profile information', 'danger');
            }
        });
    }

    function populateProfileForm(user) {
        $('#userId').val(user.userId);
        $('#firstName').val(user.firstName || '');
        $('#lastName').val(user.lastName || '');
        $('#email').val(user.email || '');
        $('#contact').val(user.contact || '');
        $('#nicNo').val(user.nicNo || '');
        $('#userName').val(user.userName || '');
        $('#address').val(user.address || '');
        $('#status').val(user.status || 'ACTIVE');
        $('#roles').val(user.roles ? Array.from(user.roles).join(', ') : 'USER');
    }

    function populateProfileSidebar(user) {
        const initials = (user.firstName || '')[0] + (user.lastName || '')[0];
        $('#profileName').text(`${user.firstName || ''} ${user.lastName || ''}`.trim() || 'User');
        $('#profileEmail').text(user.email || 'No email');
        $('#profileContact').text(user.contact || 'No contact');
        $('#profileId').text(user.userId || 'N/A');

        const status = user.status || 'ACTIVE';
        const statusBadge = status === 'ACTIVE' ? 'bg-success' : 'bg-danger';
        $('#profileStatus').removeClass('bg-success bg-danger').addClass(statusBadge).text(status);

        const roles = user.roles ? Array.from(user.roles) : ['ROLE_USER'];
        const roleText = roles.includes('ROLE_ADMIN') ? 'Admin' : 'User';
        const roleBadge = roles.includes('ROLE_ADMIN') ? 'bg-warning' : 'bg-primary';
        $('#profileRole').removeClass('bg-primary bg-warning').addClass(roleBadge).text(roleText);
    }

    function setupProfileHandlers() {
        // Profile form submission
        $('#profileForm').on('submit', function(e) {
            e.preventDefault();
            if (!validateProfileForm()) return;
            updateProfile();
        });

        // Security form submission
        $('#securityForm').on('submit', function(e) {
            e.preventDefault();
            if (!validateSecurityForm()) return;
            updatePassword();
        });

        // Password toggle
        $('#toggleNewPassword').click(function() {
            const $password = $('#newPassword');
            const type = $password.attr('type') === 'password' ? 'text' : 'password';
            $password.attr('type', type);
            $(this).find('i').toggleClass('fa-eye fa-eye-slash');
        });

        // Password change toggle
        $('#passwordChange').on('change', function() {
            const showFields = $(this).is(':checked');
            $('#currentPassword, #newPassword, #confirmNewPassword').toggle(showFields);
            if (!showFields) {
                resetSecurityForm();
            }
        });

        // Real-time validation
        $('#confirmNewPassword').on('input', function() {
            const newPassword = $('#newPassword').val();
            const confirmPassword = $(this).val();
            if (confirmPassword && newPassword !== confirmPassword) {
                $(this).addClass('is-invalid');
            } else {
                $(this).removeClass('is-invalid');
            }
        });
    }

    function validateProfileForm() {
        const $form = $('#profileForm');
        const formData = collectProfileData();

        // Required fields
        if (!formData.firstName?.trim() || !formData.lastName?.trim() ||
            !formData.email?.trim() || !formData.contact?.trim() ||
            !formData.address?.trim()) {
            showAlert('Please fill in all required fields', 'warning');
            return false;
        }

        // Email validation
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(formData.email)) {
            showAlert('Please enter a valid email address', 'warning');
            return false;
        }

        // Phone validation
        const phoneRegex = /^\+?\d{10,15}$/;
        if (!phoneRegex.test(formData.contact)) {
            showAlert('Please enter a valid phone number (+94712345678)', 'warning');
            return false;
        }

        return true;
    }

    function validateSecurityForm() {
        const passwordChange = $('#passwordChange').is(':checked');

        if (!passwordChange) {
            return true; // No password change requested
        }

        const currentPassword = $('#currentPassword').val();
        const newPassword = $('#newPassword').val();
        const confirmPassword = $('#confirmNewPassword').val();

        if (!currentPassword || !newPassword || !confirmPassword) {
            showAlert('Please fill in all password fields', 'warning');
            return false;
        }

        if (newPassword.length < 6) {
            showAlert('New password must be at least 6 characters', 'warning');
            return false;
        }

        if (newPassword !== confirmPassword) {
            showAlert('New passwords do not match', 'warning');
            return false;
        }

        return true;
    }

    function collectProfileData() {
        return {
            userId: $('#userId').val(),
            firstName: $('#firstName').val().trim(),
            lastName: $('#lastName').val().trim(),
            email: $('#email').val().trim(),
            contact: $('#contact').val().trim(),
            nicNo: $('#nicNo').val().trim(),
            userName: $('#userName').val().trim(),
            address: $('#address').val().trim(),
            status: $('#status').val(),
            roles: $('#roles').val()
        };
    }

    function updateProfile() {
        const profileData = collectProfileData();
        const $btn = $('#profileForm button[type="submit"]');
        const originalText = $btn.html();

        setLoadingState($btn, true);

        // Remove readonly fields for submission
        const submitData = { ...profileData };
        delete submitData.status;
        delete submitData.roles;

        $.ajax({
            url: '/api/users/me',
            method: 'PUT',
            contentType: 'application/json',
            headers: getAuthHeaders(),
            data: JSON.stringify(submitData),
            success: function(updatedUser) {
                showAlert('Profile updated successfully!', 'success');
                populateProfileForm(updatedUser);
                populateProfileSidebar(updatedUser);
            },
            error: function(xhr) {
                let message = 'Failed to update profile';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    message = xhr.responseJSON.message;
                }
                showAlert(message, 'danger');
            },
            complete: function() {
                setLoadingState($btn, false);
                $btn.html(originalText);
            }
        });
    }

    function updatePassword() {
        const passwordChange = $('#passwordChange').is(':checked');
        if (!passwordChange) {
            showAlert('Please check "I want to change my password"', 'info');
            return;
        }

        const passwordData = {
            currentPassword: $('#currentPassword').val(),
            password: $('#newPassword').val() // This will be the new password
        };

        const $btn = $('#securityForm button[type="submit"]');
        const originalText = $btn.html();

        setLoadingState($btn, true);

        // Note: You'll need to implement password change endpoint or modify existing one
        $.ajax({
            url: '/api/users/me/password', // You may need to add this endpoint
            method: 'PUT',
            contentType: 'application/json',
            headers: getAuthHeaders(),
            data: JSON.stringify(passwordData),
            success: function() {
                showAlert('Password updated successfully! You will be logged out for security.', 'success');
                setTimeout(() => {
                    logout();
                }, 2000);
            },
            error: function(xhr) {
                let message = 'Failed to update password';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    message = xhr.responseJSON.message;
                }
                showAlert(message, 'danger');
            },
            complete: function() {
                setLoadingState($btn, false);
                $btn.html(originalText);
            }
        });
    }

    function resetForm() {
        loadProfileData(); // Reload original data
        showAlert('Form reset to original values', 'info');
    }

    function resetSecurityForm() {
        $('#securityForm')[0].reset();
        $('#passwordChange').prop('checked', false);
        $('#currentPassword, #newPassword, #confirmNewPassword').hide();
        $('#newPassword, #confirmNewPassword').removeClass('is-invalid');
    }

    function loadBookingStats() {
        $.ajax({
            url: '/api/bookings/user',
            method: 'GET',
            headers: getAuthHeaders(),
            success: function(bookings) {
                const total = bookings.length;
                const active = bookings.filter(b => b.status === 'APPROVED' || b.status === 'PENDING').length;

                $('#totalBookings').text(total);
                $('#activeBookings').text(active);
            },
            error: function() {
                $('#totalBookings').text('0');
                $('#activeBookings').text('0');
            }
        });
    }

    // Utility to get user ID from JWT token (if stored)
    function getUserIdFromToken() {
        const token = localStorage.getItem('jwtToken');
        if (!token) return null;

        try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            return payload.userId || payload.sub;
        } catch (e) {
            return null;
        }
    }
</script>
</body>
</html>
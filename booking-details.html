<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Booking Details - DriveNow</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/print-js/1.6.0/print.min.css" rel="stylesheet">
  <link href="/css/custom.css" rel="stylesheet">
</head>
<body>
<!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
  <div class="container">
    <a class="navbar-brand fw-bold" href="${isAdmin() ? '/admin.html' : '/'}">
      <i class="fas fa-car me-2"></i>${isAdmin() ? 'DriveNow Admin' : 'DriveNow'}
    </a>
    <div class="navbar-nav ms-auto" id="authNav">
      <!-- Dynamic auth links -->
    </div>
  </div>
</nav>

<div class="container my-5">
  <div class="row">
    <div class="col-12">
      <div id="alert-container"></div>
      <div class="d-flex justify-content-between align-items-center mb-4">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item">
              <a href="${isAdmin() ? '/admin-bookings.html' : '/my-bookings.html'}">
                ${isAdmin() ? 'All Bookings' : 'My Bookings'}
              </a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">Booking Details</li>
          </ol>
        </nav>
        <div class="btn-group" role="group">
          <button class="btn btn-outline-primary" onclick="printBooking()">
            <i class="fas fa-print me-2"></i>Print Receipt
          </button>
          <a href="${isAdmin() ? '/admin-bookings.html' : '/my-bookings.html'}"
             class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to List
          </a>
        </div>
      </div>
    </div>
  </div>

  <div class="row" id="bookingDetailsContent">
    <!-- Loading state -->
    <div class="col-12 text-center py-5">
      <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="text-muted">Loading booking details...</p>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/print-js/1.6.0/print.min.js"></script>
<script src="/js/app.js"></script>
<script>
  $(document).ready(function() {
      checkAuthStatus();
      if (!isAuthenticated()) {
          window.location.href = '/login.html';
          return;
      }

      const urlParams = new URLSearchParams(window.location.search);
      const bookingId = urlParams.get('id');

      if (!bookingId) {
          showAlert('No booking ID provided', 'danger');
          setTimeout(() => {
              window.location.href = isAdmin() ? '/admin-bookings.html' : '/my-bookings.html';
          }, 2000);
          return;
      }

      loadBookingDetails(bookingId);
  });

  function loadBookingDetails(bookingId) {
      const endpoint = isAdmin() ? `/api/bookings/${bookingId}` : `/api/bookings/${bookingId}`;

      $.ajax({
          url: endpoint,
          method: 'GET',
          headers: getAuthHeaders(),
          success: function(booking) {
              displayBookingDetails(booking);
              setupBookingActions(booking);
          },
          error: function(xhr) {
              let message = 'Failed to load booking details';
              if (xhr.status === 404) {
                  message = 'Booking not found';
              } else if (xhr.responseJSON && xhr.responseJSON.message) {
                  message = xhr.responseJSON.message;
              }
              showAlert(message, 'danger');
              setTimeout(() => {
                  window.location.href = isAdmin() ? '/admin-bookings.html' : '/my-bookings.html';
              }, 2000);
          }
      });
  }

  function displayBookingDetails(booking) {
      const isAdminView = isAdmin();
      const statusConfig = getStatusConfig(booking.status);
      const modelParts = booking.vehicle.model.split(' ');
      const make = modelParts[0];
      const model = modelParts.slice(1).join(' ');
      const days = calculateRentalDays(booking.pickupDate, booking.returnDate);
      const driverInfo = booking.driver ?
          `<div class="card mb-3">
              <div class="card-header bg-info text-white">
                  <h6 class="mb-0"><i class="fas fa-user-tie me-2"></i>Assigned Driver</h6>
              </div>
              <div class="card-body">
                  <div class="row">
                      <div class="col-md-6">
                          <div class="fw-medium">${booking.driver.name}</div>
                          <small class="text-muted">${booking.driver.email}</small>
                      </div>
                      <div class="col-md-6 text-md-end">
                          <div class="fw-medium">${booking.driver.contact}</div>
                          <small class="text-muted">${booking.driver.nic}</small>
                      </div>
                  </div>
              </div>
          </div>` : '';

      const adminActions = isAdminView && booking.status === 'PENDING' ? `
          <div class="card mb-3">
              <div class="card-header bg-light">
                  <h6 class="mb-0"><i class="fas fa-cogs me-2"></i>Admin Actions</h6>
              </div>
              <div class="card-body">
                  <div class="btn-group w-100" role="group">
                      <button class="btn btn-outline-success" onclick="adminAction('approve', ${booking.rentId})">
                          <i class="fas fa-check me-1"></i>Approve Booking
                      </button>
                      <button class="btn btn-outline-danger" onclick="adminAction('reject', ${booking.rentId})">
                          <i class="fas fa-times me-1"></i>Reject Booking
                      </button>
                  </div>
                  ${!booking.driver ? `
                      <div class="mt-3">
                          <button class="btn btn-outline-info w-100" onclick="assignDriver(${booking.rentId})">
                              <i class="fas fa-user-tie me-1"></i>Assign Driver
                          </button>
                      </div>
                  ` : ''}
              </div>
          </div>
      ` : '';

      const userActions = !isAdminView && booking.status === 'PENDING' ? `
          <div class="card mb-3">
              <div class="card-header bg-warning text-dark">
                  <h6 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Pending Approval</h6>
              </div>
              <div class="card-body text-center">
                  <p class="mb-3">Your booking is pending admin approval.</p>
                  <button class="btn btn-outline-danger" onclick="cancelBooking(${booking.rentId})">
                      <i class="fas fa-times me-1"></i>Cancel Booking
                  </button>
              </div>
          </div>
      ` : '';

      const content = `
          <div class="col-lg-8 mx-auto">
              <!-- Header -->
              <div class="card shadow-sm mb-4">
                  <div class="card-body text-center">
                      <h2 class="mb-2">Booking #${booking.rentId}</h2>
                      <div class="mb-3">
                          <span class="badge ${statusConfig.badgeClass} fs-5 px-3 py-2">
                              ${statusConfig.icon} ${statusConfig.label}
                          </span>
                      </div>
                      <div class="h4 text-primary mb-0">${formatCurrency(booking.payment)}</div>
                      <small class="text-muted">Total Amount</small>
                  </div>
              </div>

              <!-- Vehicle Details -->
              <div class="card shadow-sm mb-4">
                  <div class="card-header bg-primary text-white">
                      <h6 class="mb-0"><i class="fas fa-car me-2"></i>Vehicle Details</h6>
                  </div>
                  <div class="card-body">
                      <div class="row align-items-center">
                          <div class="col-md-4 text-center mb-3 mb-md-0">
                              <img src="${booking.vehicle.imageUrl || '/images/default-car.jpg'}"
                                   class="img-fluid rounded shadow-sm" style="height: 200px; object-fit: cover;"
                                   alt="${booking.vehicle.model}">
                          </div>
                          <div class="col-md-8">
                              <h5 class="mb-2">${make} ${model}</h5>
                              <div class="row mb-3">
                                  <div class="col-md-3">
                                      <small class="text-muted">Year</small>
                                      <div class="fw-medium">${booking.vehicle.year}</div>
                                  </div>
                                  <div class="col-md-3">
                                      <small class="text-muted">Category</small>
                                      <div class="fw-medium">${booking.vehicle.category}</div>
                                  </div>
                                  <div class="col-md-3">
                                      <small class="text-muted">Fuel</small>
                                      <div class="fw-medium">${booking.vehicle.fuelType}</div>
                                  </div>
                                  <div class="col-md-3">
                                      <small class="text-muted">Seats</small>
                                      <div class="fw-medium">${booking.vehicle.seats}</div>
                                  </div>
                              </div>
                              <div class="mb-2">
                                  <small class="text-muted">License Plate:</small>
                                  <span class="fw-medium ms-1">${booking.vehicle.licensePlate}</span>
                              </div>
                              <div class="mb-2">
                                  <small class="text-muted">Color:</small>
                                  <span class="fw-medium ms-1">${booking.vehicle.colour}</span>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>

              <!-- Booking Details -->
              <div class="card shadow-sm mb-4">
                  <div class="card-header bg-info text-white">
                      <h6 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>Booking Details</h6>
                  </div>
                  <div class="card-body">
                      <div class="row g-3">
                          <div class="col-md-6">
                              <div class="mb-2">
                                  <small class="text-muted">Booking Date</small>
                                  <div class="h6">${formatDate(booking.date)}</div>
                              </div>
                              <div class="mb-2">
                                  <small class="text-muted">Pickup Date</small>
                                  <div class="h6">${formatDate(booking.pickupDate)}</div>
                              </div>
                              <div class="mb-2">
                                  <small class="text-muted">Duration</small>
                                  <div class="h6">${days} ${days === 1 ? 'day' : 'days'}</div>
                              </div>
                          </div>
                          <div class="col-md-6">
                              <div class="mb-2">
                                  <small class="text-muted">Return Date</small>
                                  <div class="h6">${formatDate(booking.returnDate)}</div>
                              </div>
                              <div class="mb-2">
                                  <small class="text-muted">Total Amount</small>
                                  <div class="h6 text-primary">${formatCurrency(booking.payment)}</div>
                              </div>
                              ${booking.requirements ? `
                                  <div class="mb-2">
                                      <small class="text-muted">Requirements</small>
                                      <div class="h6">${booking.requirements}</div>
                                  </div>
                              ` : ''}
                          </div>
                      </div>
                  </div>
              </div>

              <!-- Customer Details -->
              <div class="card shadow-sm mb-4">
                  <div class="card-header bg-success text-white">
                      <h6 class="mb-0"><i class="fas fa-user me-2"></i>Customer Details</h6>
                  </div>
                  <div class="card-body">
                      <div class="row">
                          <div class="col-md-8">
                              <h6 class="mb-2">${booking.user.firstName} ${booking.user.lastName}</h6>
                              <div class="mb-2">
                                  <small class="text-muted"><i class="fas fa-envelope me-1"></i></small>
                                  <span class="fw-medium">${booking.user.email}</span>
                              </div>
                              <div class="mb-2">
                                  <small class="text-muted"><i class="fas fa-phone me-1"></i></small>
                                  <span class="fw-medium">${booking.user.contact}</span>
                              </div>
                              <div class="mb-2">
                                  <small class="text-muted"><i class="fas fa-id-card me-1"></i></small>
                                  <span class="fw-medium">${booking.user.nicNo}</span>
                              </div>
                          </div>
                          <div class="col-md-4 text-md-end">
                              <div class="mb-2">
                                  <small class="text-muted">Username</small>
                                  <div class="fw-medium">${booking.user.userName}</div>
                              </div>
                              <div>
                                  <small class="text-muted">Account Status</small>
                                  <span class="badge bg-success">${booking.user.status || 'ACTIVE'}</span>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>

              ${driverInfo}

              ${adminActions}

              ${userActions}

              <!-- Print Section (hidden, for printing) -->
              <div id="printSection" class="d-none">
                  <div class="text-center mb-4">
                      <h2>DriveNow Booking Receipt</h2>
                      <p class="lead">Booking Confirmation #${booking.rentId}</p>
                  </div>
                  <div class="row">
                      <div class="col-md-6">
                          <h6>Customer Information</h6>
                          <p><strong>${booking.user.firstName} ${booking.user.lastName}</strong></p>
                          <p>${booking.user.email} | ${booking.user.contact}</p>
                          <p>${booking.user.address || ''}</p>
                      </div>
                      <div class="col-md-6">
                          <h6>Vehicle Information</h6>
                          <p><strong>${make} ${model}</strong></p>
                          <p>${booking.vehicle.year} | ${booking.vehicle.category} | ${booking.vehicle.seats} seats</p>
                          <p>License: ${booking.vehicle.licensePlate}</p>
                      </div>
                  </div>
                  <div class="row mt-4">
                      <div class="col-md-6">
                          <h6>Rental Period</h6>
                          <p><strong>Pickup:</strong> ${formatDate(booking.pickupDate)}</p>
                          <p><strong>Return:</strong> ${formatDate(booking.returnDate)}</p>
                          <p><strong>Duration:</strong> ${days} days</p>
                      </div>
                      <div class="col-md-6">
                          <h6>Payment Details</h6>
                          <p><strong>Total Amount:</strong> ${formatCurrency(booking.payment)}</p>
                          <p><strong>Status:</strong> <span class="badge ${statusConfig.badgeClass}">${statusConfig.label}</span></p>
                          ${booking.driver ? `<p><strong>Driver:</strong> ${booking.driver.name}</p>` : ''}
                      </div>
                  </div>
                  <div class="mt-4 pt-4 border-top text-center">
                      <p class="mb-0 text-muted">Thank you for choosing DriveNow!</p>
                      <small class="text-muted">© 2025 DriveNow Car Rental</small>
                  </div>
              </div>
          </div>
      `;

      $('#bookingDetailsContent').html(content);
  }

  function setupBookingActions(booking) {
      if (isAdmin() && booking.status === 'PENDING') {
          // Admin actions already in HTML
      } else if (!isAdmin() && booking.status === 'PENDING') {
          // User can cancel - already in HTML
      }
  }

  function adminAction(action, bookingId) {
      const url = action === 'approve' ?
          `/api/admin/bookings/${bookingId}/approve` :
          `/api/admin/bookings/${bookingId}/reject`;

      const confirmMessage = action === 'approve' ?
          'Approve this booking?' : 'Reject this booking?';

      if (!confirm(confirmMessage)) return;

      $.ajax({
          url: url,
          method: 'PUT',
          headers: getAuthHeaders(),
          success: function() {
              showAlert(`${action === 'approve' ? 'Booking approved' : 'Booking rejected'} successfully!`, 'success');
              setTimeout(() => window.location.reload(), 1500);
          },
          error: function(xhr) {
              let message = `Failed to ${action} booking`;
              if (xhr.responseJSON && xhr.responseJSON.message) {
                  message = xhr.responseJSON.message;
              }
              showAlert(message, 'danger');
          }
      });
  }

  function cancelBooking(bookingId) {
      if (!confirm('Are you sure you want to cancel this booking? This action cannot be undone.')) {
          return;
      }

      $.ajax({
          url: `/api/bookings/${bookingId}/cancel`,
          method: 'PUT',
          headers: getAuthHeaders(),
          success: function() {
              showAlert('Booking cancelled successfully!', 'success');
              setTimeout(() => {
                  window.location.href = '/my-bookings.html';
              }, 1500);
          },
          error: function(xhr) {
              let message = 'Failed to cancel booking';
              if (xhr.responseJSON && xhr.responseJSON.message) {
                  message = xhr.responseJSON.message;
              }
              showAlert(message, 'danger');
          }
      });
  }

  function assignDriver(bookingId) {
      // Load available drivers and show modal
      $.ajax({
          url: '/api/admin/drivers/available',
          method: 'GET',
          headers: getAuthHeaders(),
          success: function(drivers) {
              let options = '<option value="">Select Driver...</option>';
              drivers.forEach(function(driver) {
                  options += `<option value="${driver.driverId}">${driver.name} (${driver.contact})</option>`;
              });

              const modalHtml = `
                  <div class="modal fade" id="assignDriverModal" tabindex="-1">
                      <div class="modal-dialog">
                          <div class="modal-content">
                              <div class="modal-header">
                                  <h5 class="modal-title">Assign Driver to Booking #${bookingId}</h5>
                                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                              </div>
                              <div class="modal-body">
                                  <select class="form-select" id="driverSelect" style="width: 100%;">
                                      ${options}
                                  </select>
                              </div>
                              <div class="modal-footer">
                                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                  <button type="button" class="btn btn-primary" onclick="confirmAssignDriver(${bookingId})">
                                      Assign Driver
                                  </button>
                              </div>
                          </div>
                      </div>
                  </div>
              `;

              $('body').append(modalHtml);
              $('#assignDriverModal').modal('show');
          }
      });
  }

  function confirmAssignDriver(bookingId) {
      const driverId = $('#driverSelect').val();
      if (!driverId) {
          showAlert('Please select a driver', 'warning');
          return;
      }

      $.ajax({
          url: `/api/admin/bookings/${bookingId}/driver/${driverId}`,
          method: 'PUT',
          headers: getAuthHeaders(),
          success: function(updatedBooking) {
              showAlert('Driver assigned successfully!', 'success');
              $('#assignDriverModal').modal('hide');
              setTimeout(() => window.location.reload(), 1000);
          },
          error: function(xhr) {
              let message = 'Failed to assign driver';
              if (xhr.responseJSON && xhr.responseJSON.message) {
                  message = xhr.responseJSON.message;
              }
              showAlert(message, 'danger');
          }
      });
  }

  function printBooking() {
      const bookingId = new URLSearchParams(window.location.search).get('id');
      const printData = {
          bookingId: bookingId,
          printSection: $('#printSection')[0]
      };

      // Hide non-print elements
      $('.no-print').hide();
      $('#printSection').removeClass('d-none');

      // Trigger browser print
      window.print();

      // Restore after print
      setTimeout(() => {
          $('.no-print').show();
          $('#printSection').addClass('d-none');
      }, 1000);
  }

  function getStatusConfig(status) {
      return {
          'PENDING': {
              label: 'Pending Approval',
              badgeClass: 'bg-warning text-dark',
              icon: 'fas fa-clock'
          },
          'APPROVED': {
              label: 'Approved',
              badgeClass: 'bg-success',
              icon: 'fas fa-check-circle'
          },
          'CANCELLED': {
              label: 'Cancelled',
              badgeClass: 'bg-secondary',
              icon: 'fas fa-times-circle'
          }
      }[status] || {
          label: status,
          badgeClass: 'bg-secondary',
          icon: 'fas fa-question-circle'
      };
  }
</script>
</body>
</html>
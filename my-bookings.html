<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Bookings - DriveNow</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/css/custom.css" rel="stylesheet">
</head>
<body>
<!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
    <div class="container">
        <a class="navbar-brand fw-bold" href="/">
            <i class="fas fa-car me-2"></i>DriveNow
        </a>
        <div class="navbar-nav ms-auto" id="authNav">
            <!-- Dynamic auth links -->
        </div>
    </div>
</nav>

<div class="container my-5">
    <div class="row">
        <div class="col-12">
            <div id="alert-container"></div>
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-list me-2 text-primary"></i>My Bookings</h2>
                <a href="/booking.html" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>New Booking
                </a>
            </div>

            <!-- Filters -->
            <div class="card mb-4 shadow-sm">
                <div class="card-body">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-3">
                            <label class="form-label small">Status</label>
                            <select class="form-select" id="statusFilter">
                                <option value="">All Bookings</option>
                                <option value="PENDING">Pending Approval</option>
                                <option value="APPROVED">Approved</option>
                                <option value="CANCELLED">Cancelled</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small">Date Range</label>
                            <input type="date" class="form-control" id="dateFilter">
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-outline-secondary" id="clearFilters">
                                <i class="fas fa-times me-2"></i>Clear Filters
                            </button>
                        </div>
                        <div class="col-md-3 text-end">
                            <span class="badge bg-primary fs-6" id="bookingCount">0 total</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bookings Grid -->
            <div class="row g-4" id="bookingsGrid">
                <div class="col-12">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                            <span class="visually-hidden">Loading bookings...</span>
                        </div>
                        <p class="text-muted">Loading your bookings</p>
                    </div>
                </div>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="row g-4" style="display: none;">
                <div class="col-12 text-center py-5">
                    <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted mb-2">No bookings yet</h4>
                    <p class="text-muted mb-4">Start your journey with DriveNow by booking your first vehicle</p>
                    <a href="/booking.html" class="btn btn-primary btn-lg">
                        <i class="fas fa-car me-2"></i>Book a Vehicle
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="/js/app.js"></script>
<script>
    $(document).ready(function() {
        checkAuthStatus();
        if (!isAuthenticated()) {
            window.location.href = '/login.html';
            return;
        }

        loadUserBookings();
        setupFilters();
    });

    let allBookings = [];
    let filteredBookings = [];

    function loadUserBookings() {
        $.ajax({
            url: '/api/bookings/user',
            method: 'GET',
            headers: getAuthHeaders(),
            success: function(bookings) {
                allBookings = bookings;
                filteredBookings = bookings;
                renderBookings(bookings);
                updateStats(bookings.length);

                // Check for new booking parameter
                const urlParams = new URLSearchParams(window.location.search);
                const newBookingId = urlParams.get('newBooking');
                if (newBookingId) {
                    showAlert(`Booking #${newBookingId} created successfully!`, 'success');
                    highlightNewBooking(newBookingId);
                }
            },
            error: function() {
                showAlert('Failed to load your bookings', 'danger');
                $('#bookingsGrid').html(`
                    <div class="col-12">
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Unable to load bookings. Please try again.
                        </div>
                    </div>
                `);
            }
        });
    }

    function renderBookings(bookings) {
        if (bookings.length === 0) {
            $('#bookingsGrid').hide();
            $('#emptyState').show();
            return;
        }

        $('#emptyState').hide();
        $('#bookingsGrid').show().html('');

        bookings.forEach(function(booking) {
            const statusConfig = getStatusConfig(booking.status);
            const modelParts = booking.vehicle.model.split(' ');
            const make = modelParts[0];
            const model = modelParts.slice(1).join(' ');
            const days = calculateRentalDays(booking.pickupDate, booking.returnDate);

            const bookingCard = `
                <div class="col-xl-4 col-lg-6 col-md-12">
                    <div class="card h-100 booking-card ${statusConfig.color} shadow-sm">
                        <div class="card-body">
                            <!-- Header -->
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div>
                                    <h6 class="mb-1">${make} ${model}</h6>
                                    <small class="text-muted">${booking.vehicle.year} â€¢ ${booking.vehicle.category}</small>
                                </div>
                                <div class="text-end">
                                    <span class="badge ${statusConfig.badgeClass} mb-1 d-block fs-6">
                                        ${statusConfig.icon} ${statusConfig.label}
                                    </span>
                                    <small class="text-muted">ID: #${booking.rentId}</small>
                                </div>
                            </div>

                            <!-- Vehicle Image -->
                            <div class="text-center mb-3">
                                <img src="${booking.vehicle.imageUrl || '/images/default-car.jpg'}"
                                     class="rounded" style="height: 120px; width: 100%; object-fit: cover;"
                                     alt="${booking.vehicle.model}">
                            </div>

                            <!-- Details -->
                            <div class="mb-3">
                                <div class="row g-2 small">
                                    <div class="col-6">
                                        <div class="text-muted">Pickup</div>
                                        <div class="fw-medium">${formatDate(booking.pickupDate)}</div>
                                    </div>
                                    <div class="col-6">
                                        <div class="text-muted">Return</div>
                                        <div class="fw-medium">${formatDate(booking.returnDate)}</div>
                                    </div>
                                    <div class="col-6">
                                        <div class="text-muted">Duration</div>
                                        <div class="fw-medium">${days} ${days === 1 ? 'day' : 'days'}</div>
                                    </div>
                                    <div class="col-6">
                                        <div class="text-muted">Total</div>
                                        <div class="h6 text-primary mb-0">${formatCurrency(booking.payment)}</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Actions -->
                            <div class="mt-auto">
                                <div class="btn-group w-100" role="group">
                                    <button class="btn btn-outline-primary btn-sm flex-fill"
                                            onclick="viewBookingDetails(${booking.rentId})">
                                        <i class="fas fa-eye me-1"></i>View Details
                                    </button>
                                    ${booking.status === 'PENDING' ?
                                        `<button class="btn btn-outline-danger btn-sm flex-fill"
                                                 onclick="confirmCancel(${booking.rentId}, '${booking.vehicle.model}')">
                                            <i class="fas fa-times me-1"></i>Cancel
                                        </button>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            $('#bookingsGrid').append(bookingCard);
        });
    }

    function setupFilters() {
        $('#statusFilter').on('change', applyFilters);
        $('#dateFilter').on('change', applyFilters);
        $('#clearFilters').on('click', function() {
            $('#statusFilter').val('');
            $('#dateFilter').val('');
            applyFilters();
        });
    }

    function applyFilters() {
        const statusFilter = $('#statusFilter').val();
        const dateFilter = $('#dateFilter').val();

        filteredBookings = allBookings.filter(function(booking) {
            let matches = true;

            if (statusFilter && booking.status !== statusFilter) {
                matches = false;
            }

            if (dateFilter && booking.pickupDate !== dateFilter) {
                matches = false;
            }

            return matches;
        });

        renderBookings(filteredBookings);
        updateStats(filteredBookings.length);
    }

    function updateStats(count) {
        const totalText = count === 1 ? 'booking' : 'bookings';
        $('#bookingCount').text(`${count} ${totalText}`);
    }

    function highlightNewBooking(bookingId) {
        $(`.booking-card:has([onclick*="${bookingId}"])`).addClass('border-primary');
        setTimeout(() => {
            $(`.booking-card:has([onclick*="${bookingId}"])`).removeClass('border-primary');
        }, 5000);
    }

    function viewBookingDetails(bookingId) {
        window.location.href = `booking-details.html?id=${bookingId}`;
    }

    function confirmCancel(bookingId, vehicleName) {
        if (confirm(`Are you sure you want to cancel your booking for ${vehicleName}?\nThis action cannot be undone.`)) {
            cancelBooking(bookingId);
        }
    }

    function cancelBooking(bookingId) {
        const $btn = $(`button[onclick*="cancelBooking(${bookingId})"]`);
        const originalText = $btn.html();

        setLoadingState($btn, true);

        $.ajax({
            url: `/api/bookings/${bookingId}/cancel`,
            method: 'PUT',
            headers: getAuthHeaders(),
            success: function(updatedBooking) {
                showAlert('Booking cancelled successfully', 'success');
                loadUserBookings(); // Refresh the list
            },
            error: function() {
                showAlert('Failed to cancel booking. Please try again.', 'danger');
            },
            complete: function() {
                setLoadingState($btn, false);
                $btn.html(originalText);
            }
        });
    }

    function getStatusConfig(status) {
        const config = {
            'PENDING': {
                label: 'Pending',
                color: 'border-warning',
                badgeClass: 'bg-warning text-dark',
                icon: '<i class="fas fa-clock me-1"></i>'
            },
            'APPROVED': {
                label: 'Approved',
                color: 'border-success',
                badgeClass: 'bg-success',
                icon: '<i class="fas fa-check-circle me-1"></i>'
            },
            'CANCELLED': {
                label: 'Cancelled',
                color: 'border-secondary',
                badgeClass: 'bg-secondary',
                icon: '<i class="fas fa-times-circle me-1"></i>'
            }
        };
        return config[status] || config['PENDING'];
    }

    function calculateRentalDays(startDate, endDate) {
        const start = new Date(startDate);
        const end = new Date(endDate);
        const diffTime = Math.abs(end - start);
        return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    }
</script>
</body>
</html>